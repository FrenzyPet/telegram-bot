name: CI for Telegram Bot

on: [push, pull_request]

jobs:
  init_check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test imports
        run: |
          python -c "import telebot; from dotenv import load_dotenv; print('All imports successful')"

      - name: Syntax check
        run: |
          python -m py_compile bot.py
          echo "âœ… Syntax is correct"

  deploy:
    runs-on: ubuntu-latest
    needs: init_check
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            cd /home/frenzy/projects

            # ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
            if [ -d "telegram-bot" ]; then
              echo "ğŸ“ Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼..."
              cd telegram-bot
              git config --global --add safe.directory $(pwd)
              git reset --hard origin/main
              git clean -fd
              git pull origin main
            else
              echo "ğŸ“ ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹..."
              git clone https://github.com/${{ github.repository }}.git telegram-bot
              cd telegram-bot
            fi

            echo "ğŸ”§ Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ¼Ñ‹ Ğ² Ğ½ÑƒĞ¶Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ğ¿ĞºĞµ: $(pwd)"

            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ
            echo "ğŸ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ venv (ĞµÑĞ»Ğ¸ ĞµÑ‰Ñ‘ Ğ½ĞµÑ‚)..."
            if [ ! -d "venv" ]; then
              if ! python3 -m venv venv 2>/tmp/venv.err; then
                echo "âš ï¸ python3 -m venv Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ», Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ virtualenv"
                python3 -m pip install --user virtualenv
                export PATH="$HOME/.local/bin:$PATH"
                ~/.local/bin/virtualenv venv
              fi
            fi

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ pip Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ venv, ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ â€” ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼ get-pip.py
            if [ ! -f "venv/bin/pip" ]; then
              echo "âš ï¸ pip Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² venv, ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼..."
              curl -sS https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py
              ./venv/bin/python /tmp/get-pip.py
            fi

            echo "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ² venv..."
            ./venv/bin/pip install --upgrade pip
            ./venv/bin/pip install -r requirements.txt

            echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ..."
            ./venv/bin/python -m pip list
            ./venv/bin/python -c "import telebot, openai; print('âœ… Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚')"

            echo "ğŸ” Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ .env"
            echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" > .env

            echo "âœ… Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹!"

      - name: Setup systemd service
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            cd /home/frenzy/projects/telegram-bot

            echo "ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ systemd service..."
            mkdir -p logs

            # ĞŸĞ¾Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ²Ğ»Ğ°Ğ´ĞµĞµÑ‚ venv (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ deploy Ğ¸Ğ»Ğ¸ frenzy)
            sed "s/{{USER}}/frenzy/g" config/telegram-bot.service.template | sudo tee /etc/systemd/system/telegram-bot.service > /dev/null
            sudo chmod 644 /etc/systemd/system/telegram-bot.service

            echo "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ systemd..."
            sudo systemctl daemon-reload
            sudo systemctl enable telegram-bot.service

            echo "ğŸš€ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°..."
            sudo systemctl restart telegram-bot.service

            echo "ğŸ“Š ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ..."
            sudo systemctl status telegram-bot.service --no-pager
